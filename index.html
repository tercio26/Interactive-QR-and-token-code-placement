<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QR Code & Token Overlay</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Outlined" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded" rel="stylesheet">
    <style>
        body {
            background: #f0f2f5;
        }

        .canvas-container {
            position: relative;
            width: 100%;
            min-height: 37.5rem;
            background: #f9f9f9;
            border: 2px dashed #ddd;
            border-radius: 0.5rem;
            overflow: hidden;
        }

        .canvas-container.has-background {
            border: none;
        }

        #backgroundCanvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }

        .draggable-item {
            position: absolute;
            cursor: move;
            user-select: none;
            touch-action: none;
        }

        .draggable-item::before {
            content: '';
            position: absolute;
            top: -3px;
            left: -3px;
            right: -3px;
            bottom: -3px;
            border: 3px solid;
            border-color: inherit;
            border-radius: 0.5rem;
            background: white;
            box-shadow: 0 0.25rem 0.75rem rgba(0,0,0,0.15);
            transition: opacity 0.3s, box-shadow 0.3s;
            z-index: -1;
        }

        .draggable-item.ui-hidden::before {
            opacity: 0;
        }

        .draggable-item:hover::before {
            box-shadow: 0 0.375rem 1.25rem rgba(0,0,0,0.25);
        }

        .draggable-item.dragging {
            opacity: 0.7;
            cursor: grabbing;
        }

        .item-content {
            position: relative;
            z-index: 1;
        }

        .qr-code-wrapper {
            background: white;
            padding: 0.3125rem;
            border-radius: 0.25rem;
        }

        .token-code {
            padding: 1.25rem;
            font-family: monospace;
            font-weight: 700;
            word-break: break-all;
            text-align: center;
            min-height: 1.25rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .resize-handle {
            position: absolute;
            width: 1.25rem;
            height: 1.25rem;
            background: #2196F3;
            border: 2px solid white;
            border-radius: 50%;
            z-index: 10;
            transition: opacity 0.3s;
        }

        .resize-handle.bottom-right {
            bottom: -0.625rem;
            right: -0.625rem;
            cursor: nwse-resize;
        }

        .ui-hidden .resize-handle {
            display: none;
        }

        .item-controls {
            position: absolute;
            top: -2.5rem;
            right: -3px;
            display: flex;
            gap: 0.3125rem;
            opacity: 0;
            transition: opacity 0.3s;
            z-index: 15;
        }

        .draggable-item:hover .item-controls {
            opacity: 1;
        }

        .ui-hidden .item-controls {
            display: none;
        }

        .control-btn {
            width: 1.5rem;
            height: 1.5rem;
            border: none;
            border-radius: 0.375rem;
            cursor: pointer;
            font-size: 0.875rem;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            background: white;
            box-shadow: 0 0.125rem 0.375rem rgba(0,0,0,0.2);
            padding: 0;
        }

        .control-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 0.1875rem 0.625rem rgba(0,0,0,0.3);
        }

        .control-btn.layer-up {
            background: #4CAF50;
            color: white;
        }

        .control-btn.layer-down {
            background: #FF9800;
            color: white;
        }

        .control-btn.edit {
            background: #2196F3;
            color: white;
        }

        .placeholder-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #999;
            font-size: 1.125rem;
            text-align: center;
            pointer-events: none;
        }

        .code-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }

        .code-modal.active {
            display: flex;
        }

        .code-modal-content {
            background: #1e1e1e;
            padding: 1.25rem;
            border-radius: 0.625rem;
            max-width: 37.5rem;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 0.625rem 2.5rem rgba(0,0,0,0.5);
        }

        .code-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.9375rem;
            color: #fff;
        }

        .code-modal-header h3 {
            margin: 0;
            font-size: 1.125rem;
        }

        .code-block {
            background: #2d2d2d;
            border: 1px solid #444;
            border-radius: 0.375rem;
            padding: 0.9375rem;
            font-family: 'Courier New', monospace;
            font-size: 0.8125rem;
            color: #a9b7c6;
            overflow-x: auto;
            white-space: pre;
            line-height: 1.5;
        }

        .code-key {
            color: #cc7832;
        }

        .code-string {
            color: #6a8759;
        }

        .code-number {
            color: #6897bb;
        }

        .code-boolean {
            color: #cc7832;
        }

        .color-palette {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .color-option {
            width: 1.875rem;
            height: 1.875rem;
            border-radius: 0.25rem;
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.3s;
        }

        .color-option:hover {
            transform: scale(1.1);
        }

        .color-option.selected {
            border-color: #333;
            box-shadow: 0 0 0 2px white, 0 0 0 4px #333;
        }

        .opacity-control {
            display: flex;
            align-items: center;
            gap: 0.625rem;
        }

        .opacity-control input[type="range"] {
            flex: 1;
        }

        .opacity-value {
            min-width: 2.8125rem;
            font-weight: 600;
        }

        .icon-lg {
            font-size: 2rem;
        }

        .icon-md {
            font-size: 1.125rem;
        }

        .icon-sm {
            font-size: 1rem;
        }

        .icon-xs {
            font-size: 0.875rem;
        }

        .btn-icon-sm {
            padding: 0.125rem 0.5rem;
            font-size: 0.6875rem;
        }

        .max-h-sidebar {
            max-height: calc(100vh - 12.5rem);
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <div class="container-fluid py-4">
        <div class="card shadow-sm mb-4">
            <div class="card-body">
                <h1 class="h3 mb-3">
                    <span class="material-icons-outlined me-2 icon-lg">palette</span>
                    QR Code & Token Overlay Editor
                </h1>
                <div class="d-flex gap-2 flex-wrap align-items-center">
                    <label for="backgroundImage" class="btn btn-success d-flex align-items-center">
                        <span class="material-icons-outlined me-1 icon-md">upload_file</span>
                        Upload Background
                    </label>
                    <input type="file" id="backgroundImage" accept="image/*" class="d-none">
                    <button class="btn btn-primary d-flex align-items-center" id="addQRBtn">
                        <span class="material-icons me-1 icon-md">qr_code_2</span>
                        Add QR Code
                    </button>
                    <button class="btn btn-primary d-flex align-items-center" id="addTokenBtn">
                        <span class="material-icons me-1 icon-md">label</span>
                        Add Token
                    </button>
                    <button class="btn btn-secondary d-flex align-items-center" id="toggleUIBtn">
                        <span class="material-icons me-1 icon-md">visibility_off</span>
                        <span class="toggle-text">Hide UI</span>
                    </button>
                    <span class="text-muted ms-2" id="itemCount">0/10 items</span>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-md-3">
                <div class="card shadow-sm max-h-sidebar">
                    <div class="card-body">
                        <h5 class="card-title">Items List</h5>
                        <div id="itemList" class="d-flex flex-column gap-2"></div>
                    </div>
                </div>
            </div>

            <div class="col-md-9">
                <div class="card shadow-sm">
                    <div class="card-body">
                        <div class="canvas-container" id="canvasContainer">
                            <canvas id="backgroundCanvas"></canvas>
                            <div class="placeholder-text" id="placeholder">
                                Upload background and add QR/Token items
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- QR Code Modal -->
    <div class="modal fade" id="addQRModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Add QR Code</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Content to encode:</label>
                        <input type="text" class="form-control" id="qrContentInput" placeholder="Enter content for QR Code...">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">QR Code Size (px):</label>
                        <input type="number" class="form-control" id="qrSizeInput" value="150" min="50" max="500" step="10">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Border Color:</label>
                        <div class="color-palette" id="qrColorPalette"></div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="confirmQRBtn">Add</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Token Modal -->
    <div class="modal fade" id="addTokenModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Add Token Code</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Token Text:</label>
                        <input type="text" class="form-control" id="tokenContentInput" placeholder="Enter token code...">
                    </div>
                    <div class="row g-2 mb-3">
                        <div class="col-6">
                            <label class="form-label">Font Size (px):</label>
                            <input type="number" class="form-control" id="tokenFontSize" value="16" min="8" max="72" step="1">
                        </div>
                        <div class="col-6">
                            <label class="form-label">Text Color:</label>
                            <input type="color" class="form-control form-control-color w-100" id="tokenTextColor" value="#000000">
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Background Color:</label>
                        <input type="color" class="form-control form-control-color w-100" id="tokenBgColor" value="#ffffff">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Background Opacity:</label>
                        <div class="opacity-control">
                            <input type="range" class="form-range" id="tokenBgOpacity" min="0" max="100" value="100">
                            <span class="opacity-value" id="tokenBgOpacityValue">100%</span>
                        </div>
                    </div>
                    <div class="row g-2 mb-3">
                        <div class="col-6">
                            <label class="form-label">Width (px):</label>
                            <input type="number" class="form-control" id="tokenWidth" value="200" min="20" max="800" step="10">
                        </div>
                        <div class="col-6">
                            <label class="form-label">Height (px):</label>
                            <input type="number" class="form-control" id="tokenHeight" value="100" min="20" max="600" step="10">
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Border Color:</label>
                        <div class="color-palette" id="tokenColorPalette"></div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="confirmTokenBtn">Add</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Token Edit Modal -->
    <div class="modal fade" id="editTokenModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Edit Token Properties</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Token Text:</label>
                        <input type="text" class="form-control" id="editTokenContent" placeholder="Enter token code...">
                    </div>
                    <div class="row g-2 mb-3">
                        <div class="col-6">
                            <label class="form-label">Font Size (px):</label>
                            <input type="number" class="form-control" id="editTokenFontSize" value="16" min="8" max="72" step="1">
                        </div>
                        <div class="col-6">
                            <label class="form-label">Text Color:</label>
                            <input type="color" class="form-control form-control-color w-100" id="editTokenTextColor" value="#000000">
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Background Color:</label>
                        <input type="color" class="form-control form-control-color w-100" id="editTokenBgColor" value="#ffffff">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Background Opacity:</label>
                        <div class="opacity-control">
                            <input type="range" class="form-range" id="editTokenBgOpacity" min="0" max="100" value="100">
                            <span class="opacity-value" id="editTokenBgOpacityValue">100%</span>
                        </div>
                    </div>
                    <div class="row g-2 mb-3">
                        <div class="col-6">
                            <label class="form-label">Width (px):</label>
                            <input type="number" class="form-control" id="editTokenWidth" value="200" min="20" max="800" step="10">
                        </div>
                        <div class="col-6">
                            <label class="form-label">Height (px):</label>
                            <input type="number" class="form-control" id="editTokenHeight" value="100" min="20" max="600" step="10">
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="confirmEditTokenBtn">Update</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Code View Modal -->
    <div class="code-modal" id="codeModal">
        <div class="code-modal-content">
            <div class="code-modal-header">
                <h3 class="d-flex align-items-center mb-0">
                    <span class="material-icons-outlined me-2">data_object</span>
                    Item Properties
                </h3>
                <button class="btn btn-danger btn-sm d-flex align-items-center" id="closeCodeBtn">
                    <span class="material-icons me-1 icon-sm">close</span>
                    Close
                </button>
            </div>
            <pre class="code-block" id="codeBlock"></pre>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/interactjs/dist/interact.min.js"></script>
    
    <script>
        $(document).ready(function() {
            const COLORS = [
                '#FF6B6B', '#4ECDC4', '#45B7D1', '#FFA07A', '#98D8C8',
                '#F7DC6F', '#BB8FCE', '#85C1E2', '#F8B739', '#52B788'
            ];

            let items = [];
            let selectedQRColor = COLORS[0];
            let selectedTokenColor = COLORS[0];
            let backgroundImage = null;
            let selectedItem = null;
            let editingItem = null;
            let uiHidden = false;

            // Bootstrap Modal instances
            const addQRModal = new bootstrap.Modal('#addQRModal');
            const addTokenModal = new bootstrap.Modal('#addTokenModal');
            const editTokenModal = new bootstrap.Modal('#editTokenModal');

            const $canvasContainer = $('#canvasContainer');
            const $backgroundCanvas = $('#backgroundCanvas');
            const ctx = $backgroundCanvas[0].getContext('2d');
            const $itemList = $('#itemList');

            // Initialize color palettes
            initColorPalette('qrColorPalette', 'qr');
            initColorPalette('tokenColorPalette', 'token');

            function initColorPalette(paletteId, colorVar) {
                const $palette = $(`#${paletteId}`);
                COLORS.forEach((color, index) => {
                    const $div = $('<div>')
                        .addClass('color-option')
                        .toggleClass('selected', index === 0)
                        .css('background', color)
                        .on('click', function() {
                            if (colorVar === 'qr') {
                                selectedQRColor = color;
                            } else {
                                selectedTokenColor = color;
                            }
                            $palette.find('.color-option').removeClass('selected');
                            $(this).addClass('selected');
                        });
                    $palette.append($div);
                });
            }

            // Opacity slider handlers
            $('#tokenBgOpacity').on('input', function() {
                $('#tokenBgOpacityValue').text($(this).val() + '%');
            });

            $('#editTokenBgOpacity').on('input', function() {
                $('#editTokenBgOpacityValue').text($(this).val() + '%');
            });

            // Background upload
            $('#backgroundImage').on('change', function(e) {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(event) {
                        const img = new Image();
                        img.onload = function() {
                            backgroundImage = img;
                            resizeCanvas();
                            $('#placeholder').hide();
                            $canvasContainer.addClass('has-background');
                        };
                        img.src = event.target.result;
                    };
                    reader.readAsDataURL(file);
                }
            });

            function resizeCanvas() {
                if (backgroundImage) {
                    const containerWidth = $canvasContainer.width();
                    const ratio = backgroundImage.height / backgroundImage.width;
                    $backgroundCanvas[0].width = containerWidth;
                    $backgroundCanvas[0].height = containerWidth * ratio;
                    $canvasContainer.height($backgroundCanvas[0].height);
                    ctx.drawImage(backgroundImage, 0, 0, $backgroundCanvas[0].width, $backgroundCanvas[0].height);
                }
            }

            // QR Modal
            $('#addQRBtn').on('click', function() {
                if (items.length >= 10) {
                    alert('Maximum 10 items reached!');
                    return;
                }
                $('#qrContentInput').val('');
                addQRModal.show();
            });

            $('#confirmQRBtn').on('click', function() {
                const content = $('#qrContentInput').val().trim();
                const size = parseInt($('#qrSizeInput').val());
                if (!content) {
                    alert('Please enter content!');
                    return;
                }
                addItem('qr', content, selectedQRColor, { qrSize: size });
                addQRModal.hide();
            });

            // Token Modal
            $('#addTokenBtn').on('click', function() {
                if (items.length >= 10) {
                    alert('Maximum 10 items reached!');
                    return;
                }
                $('#tokenContentInput').val('');
                $('#tokenBgOpacity').val(100);
                $('#tokenBgOpacityValue').text('100%');
                addTokenModal.show();
            });

            $('#confirmTokenBtn').on('click', function() {
                const content = $('#tokenContentInput').val().trim();
                const fontSize = parseInt($('#tokenFontSize').val());
                const textColor = $('#tokenTextColor').val();
                const bgColor = $('#tokenBgColor').val();
                const bgOpacity = parseInt($('#tokenBgOpacity').val());
                const width = parseInt($('#tokenWidth').val());
                const height = parseInt($('#tokenHeight').val());
                if (!content) {
                    alert('Please enter token!');
                    return;
                }
                addItem('token', content, selectedTokenColor, { fontSize, textColor, bgColor, bgOpacity, width, height });
                addTokenModal.hide();
            });

            // Toggle UI
            $('#toggleUIBtn').on('click', function() {
                uiHidden = !uiHidden;
                $('.draggable-item').toggleClass('ui-hidden', uiHidden);
                
                const $btn = $(this);
                const $icon = $btn.find('.material-icons');
                const $text = $btn.find('.toggle-text');
                
                if (uiHidden) {
                    $icon.text('visibility');
                    $text.text('Show UI');
                } else {
                    $icon.text('visibility_off');
                    $text.text('Hide UI');
                }
            });

            // Edit Token Modal
            $('#confirmEditTokenBtn').on('click', function() {
                if (!editingItem) return;
                
                editingItem.content = $('#editTokenContent').val().trim();
                editingItem.fontSize = parseInt($('#editTokenFontSize').val());
                editingItem.textColor = $('#editTokenTextColor').val();
                editingItem.bgColor = $('#editTokenBgColor').val();
                editingItem.bgOpacity = parseInt($('#editTokenBgOpacity').val());
                editingItem.width = parseInt($('#editTokenWidth').val());
                editingItem.height = parseInt($('#editTokenHeight').val());
                
                // Update display immediately
                const $element = $canvasContainer.find(`[data-id="${editingItem.id}"]`);
                if ($element.length) {
                    const $tokenDiv = $element.find('.token-code');
                    $tokenDiv.css({
                        fontSize: editingItem.fontSize + 'px',
                        color: editingItem.textColor,
                        backgroundColor: hexToRgba(editingItem.bgColor, editingItem.bgOpacity / 100),
                        width: editingItem.width + 'px',
                        height: editingItem.height + 'px'
                    }).text(editingItem.content);
                }
                
                $itemList.find(`[data-id="${editingItem.id}"] .text-muted`).text(editingItem.content);
                
                editTokenModal.hide();
                editingItem = null;
            });

            // Code Modal
            $('#closeCodeBtn').on('click', function() {
                $('#codeModal').removeClass('active');
            });

            function addItem(type, content, color, options = {}) {
                const id = Date.now();
                const item = { 
                    id, 
                    type, 
                    content, 
                    color,
                    x: 50,
                    y: 50 + items.length * 20,
                    zIndex: items.length,
                    ...options
                };
                
                if (type === 'qr') {
                    item.qrSize = options.qrSize || 150;
                } else {
                    item.fontSize = options.fontSize || 16;
                    item.textColor = options.textColor || '#000000';
                    item.bgColor = options.bgColor || '#ffffff';
                    item.bgOpacity = options.bgOpacity !== undefined ? options.bgOpacity : 100;
                    item.width = options.width || 200;
                    item.height = options.height || 100;
                }
                
                items.push(item);
                
                const $listItem = createListItem(item);
                $itemList.append($listItem);
                
                const $draggableItem = createDraggableItem(item);
                $canvasContainer.append($draggableItem);
                
                updateItemCount();
            }

            function createListItem(item) {
                const badge = item.type === 'qr' 
                    ? '<span class="badge bg-primary ms-1">QR</span>' 
                    : '<span class="badge bg-secondary ms-1">TOKEN</span>';
                
                const $div = $('<div>')
                    .addClass('card')
                    .css({
                        borderColor: item.color,
                        borderWidth: '2px',
                        borderStyle: 'solid',
                        cursor: 'pointer'
                    })
                    .attr('data-id', item.id)
                    .html(`
                        <div class="card-body p-2">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <span class="fw-bold small">Item #${items.length}${badge}</span>
                                <div class="d-flex gap-1">
                                    <button class="btn btn-sm btn-outline-secondary btn-code-item btn-icon-sm">
                                        <span class="material-icons-outlined icon-xs">code</span>
                                    </button>
                                    <button class="btn btn-sm btn-danger btn-remove-item btn-icon-sm">
                                        <span class="material-icons-outlined icon-xs">delete</span>
                                    </button>
                                </div>
                            </div>
                            <div class="text-muted small font-monospace text-truncate">${item.content}</div>
                        </div>
                    `);
                
                $div.find('.btn-code-item').on('click', function(e) {
                    e.stopPropagation();
                    showItemCode(item.id);
                });
                
                $div.find('.btn-remove-item').on('click', function(e) {
                    e.stopPropagation();
                    removeItem(item.id);
                });
                
                $div.on('click', function() {
                    selectItemFromList(item.id);
                });
                
                return $div;
            }

            function createDraggableItem(item) {
                const $div = $('<div>')
                    .addClass('draggable-item')
                    .toggleClass('ui-hidden', uiHidden)
                    .css({
                        borderColor: item.color,
                        left: item.x + 'px',
                        top: item.y + 'px',
                        zIndex: item.zIndex
                    })
                    .attr('data-id', item.id);
                
                // Control buttons
                const $controls = $('<div>').addClass('item-controls');
                
                $('<button>')
                    .addClass('control-btn layer-up')
                    .html('<span class="material-icons icon-sm">arrow_upward</span>')
                    .attr('title', 'Bring Forward')
                    .on('click', function(e) {
                        e.stopPropagation();
                        changeLayer(item.id, 1);
                    })
                    .appendTo($controls);
                
                $('<button>')
                    .addClass('control-btn layer-down')
                    .html('<span class="material-icons icon-sm">arrow_downward</span>')
                    .attr('title', 'Send Backward')
                    .on('click', function(e) {
                        e.stopPropagation();
                        changeLayer(item.id, -1);
                    })
                    .appendTo($controls);
                
                if (item.type === 'token') {
                    $('<button>')
                        .addClass('control-btn edit')
                        .html('<span class="material-icons icon-sm">edit</span>')
                        .attr('title', 'Edit Token')
                        .on('click', function(e) {
                            e.stopPropagation();
                            openEditTokenModal(item);
                        })
                        .appendTo($controls);
                }
                
                $div.append($controls);
                
                const $contentDiv = $('<div>').addClass('item-content');
                
                if (item.type === 'qr') {
                    const $qrWrapper = $('<div>')
                        .addClass('qr-code-wrapper')
                        .attr('id', `qr-${item.id}`);
                    $contentDiv.append($qrWrapper);
                    
                    setTimeout(() => {
                        new QRCode($qrWrapper[0], {
                            text: item.content,
                            width: item.qrSize,
                            height: item.qrSize,
                            colorDark: '#000000',
                            colorLight: '#ffffff',
                        });
                    }, 0);
                } else {
                    const bgColor = hexToRgba(item.bgColor, item.bgOpacity / 100);
                    const $tokenDiv = $('<div>')
                        .addClass('token-code')
                        .css({
                            color: item.textColor,
                            backgroundColor: bgColor,
                            fontSize: item.fontSize + 'px',
                            width: item.width + 'px',
                            height: item.height + 'px'
                        })
                        .text(item.content);
                    $contentDiv.append($tokenDiv);
                }
                
                $div.append($contentDiv);
                
                // Resize handle
                $div.append($('<div>').addClass('resize-handle bottom-right'));
                
                // Setup Interact.js
                setupInteractable($div[0], item);
                
                return $div;
            }

            function setupInteractable(element, item) {
                interact(element)
                    .draggable({
                        listeners: {
                            move(event) {
                                item.x += event.dx;
                                item.y += event.dy;
                                $(event.target).css({
                                    left: item.x + 'px',
                                    top: item.y + 'px'
                                });
                            }
                        },
                        modifiers: [
                            interact.modifiers.restrictRect({
                                restriction: 'parent',
                                endOnly: false
                            })
                        ],
                        inertia: true
                    })
                    .resizable({
                        edges: { 
                            bottom: '.resize-handle.bottom-right', 
                            right: '.resize-handle.bottom-right' 
                        },
                        listeners: {
                            move(event) {
                                const $element = $(event.target);
                                
                                if (item.type === 'qr') {
                                    const size = Math.max(event.rect.width, event.rect.height);
                                    const clampedSize = Math.max(50, Math.min(500, size));
                                    item.qrSize = clampedSize;
                                    
                                    const $qrWrapper = $element.find('.qr-code-wrapper');
                                    $qrWrapper.empty();
                                    new QRCode($qrWrapper[0], {
                                        text: item.content,
                                        width: clampedSize,
                                        height: clampedSize,
                                        colorDark: '#000000',
                                        colorLight: '#ffffff',
                                    });

                                    if (selectedItem && selectedItem.id === item.id) {
                                        $('#prop-qrSize').val(clampedSize);
                                    }
                                    if (selectedItem && selectedItem.id === item.id) {
                                        $('#prop-qrSize').val(clampedSize);
                                    }
                                } else {
                                    const newWidth = Math.max(20, Math.min(800, event.rect.width));
                                    const newHeight = Math.max(20, Math.min(600, event.rect.height));
                                    
                                    item.width = newWidth;
                                    item.height = newHeight;
                                    
                                    $element.find('.token-code').css({
                                        width: newWidth + 'px',
                                        height: newHeight + 'px'
                                    });

                                    if (selectedItem && selectedItem.id === item.id) {
                                        $('#prop-width').val(newWidth);
                                        $('#prop-height').val(newHeight);
                                    }
                                }
                            }
                        },
                        modifiers: [
                            interact.modifiers.restrictSize({
                                min: { width: 20, height: 20 },
                                max: { width: 800, height: 800 }
                            })
                        ],
                        inertia: true
                    });
            }

            function changeLayer(id, direction) {
                const item = items.find(i => i.id === id);
                if (!item) return;
                
                const currentZ = item.zIndex;
                const targetZ = currentZ + direction;
                const swapItem = items.find(i => i.zIndex === targetZ);
                
                if (swapItem) {
                    item.zIndex = targetZ;
                    swapItem.zIndex = currentZ;
                    
                    $canvasContainer.find(`[data-id="${id}"]`).css('zIndex', targetZ);
                    $canvasContainer.find(`[data-id="${swapItem.id}"]`).css('zIndex', currentZ);
                }
            }

            function openEditTokenModal(item) {
                editingItem = item;
                $('#editTokenContent').val(item.content);
                $('#editTokenFontSize').val(item.fontSize);
                $('#editTokenTextColor').val(item.textColor);
                $('#editTokenBgColor').val(item.bgColor);
                $('#editTokenBgOpacity').val(item.bgOpacity);
                $('#editTokenBgOpacityValue').text(item.bgOpacity + '%');
                $('#editTokenWidth').val(item.width);
                $('#editTokenHeight').val(item.height);
                editTokenModal.show();
            }

            function selectItemFromList(id) {
                selectedItem = items.find(i => i.id === id);
                
                $itemList.find('.card').removeClass('border-primary').css('borderWidth', '2px');
                $itemList.find(`[data-id="${id}"]`).addClass('border-primary').css('borderWidth', '3px');
            }

            function updateItemDisplay(item) {
                const $element = $canvasContainer.find(`[data-id="${item.id}"]`);
                if (!$element.length) return;
                
                if (item.type === 'qr') {
                    const $qrWrapper = $element.find('.qr-code-wrapper');
                    $qrWrapper.empty();
                    new QRCode($qrWrapper[0], {
                        text: item.content,
                        width: item.qrSize,
                        height: item.qrSize,
                        colorDark: '#000000',
                        colorLight: '#ffffff',
                    });
                } else {
                    $element.find('.token-code').css({
                        fontSize: item.fontSize + 'px',
                        color: item.textColor,
                        backgroundColor: hexToRgba(item.bgColor, item.bgOpacity / 100),
                        width: item.width + 'px',
                        height: item.height + 'px'
                    }).text(item.content);
                }
            }

            function showItemCode(id) {
                const item = items.find(i => i.id === id);
                if (!item) return;
                
                const itemCopy = {
                    id: item.id,
                    type: item.type,
                    content: item.content,
                    color: item.color,
                    x: item.x,
                    y: item.y,
                    zIndex: item.zIndex
                };
                
                if (item.type === 'qr') {
                    itemCopy.qrSize = item.qrSize;
                } else {
                    itemCopy.fontSize = item.fontSize;
                    itemCopy.textColor = item.textColor;
                    itemCopy.bgColor = item.bgColor;
                    itemCopy.bgOpacity = item.bgOpacity;
                    itemCopy.width = item.width;
                    itemCopy.height = item.height;
                }
                
                $('#codeBlock').html(formatJSON(itemCopy));
                $('#codeModal').addClass('active');
            }

            function removeItem(id) {
                items = items.filter(p => p.id !== id);
                
                $itemList.find(`[data-id="${id}"]`).remove();
                $canvasContainer.find(`.draggable-item[data-id="${id}"]`).remove();
                
                if (selectedItem && selectedItem.id === id) {
                    selectedItem = null;
                }
                
                updateItemCount();
                
                $itemList.find('.card').each(function(index) {
                    const $badge = $(this).find('.badge');
                    $(this).find('.fw-bold').html(`Item #${index + 1}${$badge.prop('outerHTML') || ''}`);
                });
            }

            function hexToRgba(hex, alpha) {
                const r = parseInt(hex.slice(1, 3), 16);
                const g = parseInt(hex.slice(3, 5), 16);
                const b = parseInt(hex.slice(5, 7), 16);
                return `rgba(${r}, ${g}, ${b}, ${alpha})`;
            }

            function formatJSON(obj) {
                const json = JSON.stringify(obj, null, 2);
                return json
                    .replace(/"([^"]+)":/g, '<span class="code-key">"$1"</span>:')
                    .replace(/: "([^"]+)"/g, ': <span class="code-string">"$1"</span>')
                    .replace(/: (\d+)/g, ': <span class="code-number">$1</span>')
                    .replace(/: (true|false)/g, ': <span class="code-boolean">$1</span>');
            }

            function updateItemCount() {
                $('#itemCount').text(`${items.length}/10 items`);
                $('#addQRBtn').prop('disabled', items.length >= 10);
                $('#addTokenBtn').prop('disabled', items.length >= 10);
            }

            $(window).on('resize', resizeCanvas);
        });
    </script>
</body>
</html>
